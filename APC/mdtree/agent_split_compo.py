import json
from openai import OpenAI

from APC.config_parser import get_args_parser
import time

PROMPT_1_CONTENT_ANALYSIS_AND_COMPONENT_SELECTION = """è¯·æ‰®æ¼”ä¸€ä½ç»éªŒä¸°å¯Œçš„æ¼”ç¤ºæ–‡ç¨¿è®¾è®¡å¸ˆå’Œä¿¡æ¯æ¶æ„å¸ˆã€‚
æ‚¨çš„é¦–è¦ä»»åŠ¡æ˜¯åˆ†ææä¾›çš„MarkdownåŸå§‹å†…å®¹ï¼Œå¹¶å°†å…¶æ™ºèƒ½åœ°åˆ†è§£å’Œåˆ†é…åˆ°æœ€åˆé€‚çš„è§†è§‰ç»„ä»¶ä¸­ã€‚æ‚¨éœ€è¦å†³å®šä½¿ç”¨å“ªäº›ç»„ä»¶ä»¥åŠæ¯ä¸ªç»„ä»¶åº”åŒ…å«å“ªäº›æ–‡æœ¬å†…å®¹ã€‚

å·²çŸ¥ä¿¡æ¯ï¼š
1.  **åŸå§‹ Markdown å†…å®¹**:
    ```markdown
    {markdown_content}
    ```
2.  **å¯ç”¨çš„è§†è§‰ç»„ä»¶ç±»å‹åŠå…¶æè¿° (ç”¨äºå†…å®¹åŒ¹é…)**:

    * **`quote_box` (å¼•ç”¨æ¡†)**: ç”¨äºå±•ç¤ºå¼•è¨€ã€åè¨€æˆ–é‡è¦çš„é™ˆè¿°ã€‚
        * **å‚æ•° (`content_params`)**:
            * `quote_text` (str): å¼•ç”¨çš„ä¸»è¦æ–‡æœ¬ã€‚
            * `attribution_text` (str, optional): å¼•ç”¨çš„å‡ºå¤„ã€‚
        * **æ ·å¼ (`style_id`)**: `"default_quote"`, `"left_accent_bar_quote"`ã€‚
        * **è§†è§‰æç¤º**: é€‚åˆç‹¬ç«‹çš„ã€æœ‰å½±å“åŠ›çš„çŸ­è¯­æˆ–æ®µè½ã€‚

    * **`data_callout` (æ•°æ®æ ‡æ³¨æ¡†)**: ç”¨äºçªå‡ºæ˜¾ç¤ºå…³é”®æ•°æ®ç‚¹ã€ç»Ÿè®¡æ•°å­—æˆ–æŒ‡æ ‡ã€‚
        * **å‚æ•° (`content_params`)**:
            * `statistic_value` (str): ä¸»è¦çš„æ•°æ®æˆ–ç»Ÿè®¡å€¼ã€‚
            * `label_text` (str): å¯¹è¯¥æ•°æ®çš„æè¿°æ€§æ ‡ç­¾ã€‚
        * **æ ·å¼ (`style_id`)**: `"default_data"`, `"circle_emphasis_data"`ã€‚
        * **è§†è§‰æç¤º**: ä½¿æ•°å­—ä¿¡æ¯ä¸€ç›®äº†ç„¶ã€‚é€‚åˆä»æ–‡æœ¬ä¸­æå–çš„ã€éœ€è¦å¼ºè°ƒçš„å­¤ç«‹æ•°æ®ç‚¹ã€‚

    * **`divider` (åˆ†éš”çº¿)**: ç”¨äºåœ¨è§†è§‰ä¸Šåˆ†éš”å¹»ç¯ç‰‡ä¸Šçš„ä¸åŒå†…å®¹åŒºåŸŸæˆ–å…ƒç´ ã€‚
        * **å‚æ•° (`content_params`)**: {{}} (é€šå¸¸ä¸ºç©º)ã€‚
        * **æ ·å¼ (`style_id`)**: `"default_line"`, `"dots_accent_line"`ã€‚
        * **è§†è§‰æç¤º**: å¸®åŠ©ç»„ç»‡å†…å®¹ï¼Œå¼•å¯¼é˜…è¯»é¡ºåºã€‚

    * **`main_text` (ä¸»æ–‡æœ¬å—)**: ç”¨äºæ”¾ç½®ä¸é€‚åˆæ”¾å…¥ç‰¹å®šç»„ä»¶çš„ã€ä¸»è¦çš„æ®µè½æ–‡æœ¬å†…å®¹ã€‚
        * **å‚æ•° (`content_params`)**:
            * `text_content` (str): åˆ†é…ç»™æ­¤ä¸»æ–‡æœ¬å—çš„ Markdown æ ¼å¼çš„æ–‡æœ¬ã€‚
        * **è§†è§‰æç¤º**: Markdownä¸­çš„æ¢è¡Œç¬¦å°†è¢«è¯†åˆ«ï¼Œä½†å¤æ‚çš„Markdownæ ‡è®°ï¼ˆå¦‚`##`æˆ–`*`ç”¨äºåˆ—è¡¨ï¼‰å°†ä½œä¸ºå­—é¢æ–‡æœ¬æ˜¾ç¤ºã€‚å¦‚æœéœ€è¦å°†æ ‡é¢˜æˆ–åˆ—è¡¨ç­‰ä¸æ™®é€šæ®µè½åŒºåˆ«å¯¹å¾…ï¼Œè¯·å°†å®ƒä»¬åˆ†é…åˆ°ä¸åŒçš„ `main_text` å…ƒç´ ä¸­ã€‚

    * **`icon_title_bullets` (å›¾æ ‡æ ‡é¢˜é¡¹ç›®ç¬¦å·)**: å·¦ä¾§ä¸ºå¸¦å›¾æ ‡å’Œæ ‡é¢˜çš„åŒºåŸŸï¼Œå³ä¾§ä¸ºé¡¹ç›®ç¬¦å·åˆ—è¡¨ã€‚
        * **å‚æ•° (`content_params`)**:
            * `icon_emoji` (str): å·¦ä¾§å›¾æ ‡æ¡†ä¸­ä½¿ç”¨çš„è¡¨æƒ…ç¬¦å·å­—ç¬¦ã€‚
            * `content_data` (dict): åŒ…å« `title` (str) å’Œ `bullets` (list of str) çš„å­—å…¸ã€‚
        * **è§†è§‰æç¤º**: é€‚ç”¨äºå±•ç¤ºä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µæˆ–ä¸»é¢˜ï¼ˆç”±å›¾æ ‡å’Œæ ‡é¢˜ä»£è¡¨ï¼‰ï¼Œå¹¶è¾…ä»¥å¤šä¸ªç›¸å…³çš„å…³é”®ç‚¹ã€‚å¯»æ‰¾H2/H3çº§åˆ«æ ‡é¢˜åç´§è·Ÿé¡¹ç›®ç¬¦å·åˆ—è¡¨çš„ç»“æ„ã€‚

    * **`triple_card` (ä¸‰å¡ç‰‡ç»„)**: å¹¶æ’å±•ç¤ºä¸‰ä¸ªå¸¦æœ‰æ ‡é¢˜å’Œå†…å®¹çš„å¡ç‰‡ã€‚
        * **å‚æ•° (`content_params`)**:
            * `cards_data` (list of 3 dicts): æ¯ä¸ªå­—å…¸åŒ…å« `title` (str) å’Œ `content` (str)ã€‚åˆ—è¡¨å¿…é¡»æ°å¥½åŒ…å«ä¸‰ä¸ªå…ƒç´ ã€‚
            * `card_top_emojis` (list of str, optional): å¡ç‰‡é¡¶éƒ¨çš„å¯é€‰è¡¨æƒ…ç¬¦å·ã€‚
            * `card_icon_chars` (list of str, optional): å¡ç‰‡å³ä¸‹è§’çš„å¯é€‰å›¾æ ‡å­—ç¬¦ã€‚
        * **è§†è§‰æç¤º**: é€‚åˆæ¯”è¾ƒä¸‰ä¸ªç›¸å…³é¡¹ç›®ã€‚å¯»æ‰¾å¯å¹³å‡åˆ†ä¸ºä¸‰éƒ¨åˆ†çš„ç»“æ„ï¼Œå¦‚ä¸‰ä¸ªè¿ç»­çš„`###`æˆ–`####`çº§åˆ«æ ‡é¢˜å¼•å¯¼çš„å°èŠ‚ã€‚

    * **`parallel_boxes` (å¹¶è¡ŒåŒæ¡†)**: å¹¶æ’å±•ç¤ºä¸¤ä¸ªæ–‡æœ¬æ¡†ã€‚
        * **å‚æ•° (`content_params`)**:
            * `title_text` (str): å·¦ä¾§æ¡†çš„ä¸»è¦æ–‡æœ¬å†…å®¹ã€‚
            * `content_text` (str): å³ä¾§æ¡†çš„ä¸»è¦æ–‡æœ¬å†…å®¹ã€‚
            * `emoji_left` (str, optional): å·¦ä¾§æ¡†é¡¶éƒ¨çš„è¡¨æƒ…ç¬¦å·ã€‚
            * `emoji_right` (str, optional): å³ä¾§æ¡†é¡¶éƒ¨çš„è¡¨æƒ…ç¬¦å·ã€‚
        * **è§†è§‰æç¤º**: é€‚ç”¨äºå¹¶åˆ—å±•ç¤ºä¸¤é¡¹ç›¸å…³ä¿¡æ¯ï¼Œå¦‚å¯¹æ¯”ã€åŸå› ä¸ç»“æœç­‰ã€‚å¯»æ‰¾å¯æ¸…æ™°åˆ†ä¸ºä¸¤ä¸ªè¯­ä¹‰ç›¸å…³ä¸”å†…å®¹é‡å¤§è‡´å‡è¡¡çš„æ–‡æœ¬å—ã€‚

éœ€æ±‚ï¼š
1.  **å†…å®¹åˆ†æä¸ç»„ä»¶é€‰æ‹©**:
    * æ·±å…¥ç†è§£ Markdown å†…å®¹çš„ç»“æ„ï¼ˆåˆ—è¡¨ã€å„çº§æ ‡é¢˜ H1-H6ï¼‰å’Œè¯­ä¹‰ã€‚
    * æ ¹æ®å†…å®¹ç‰¹ç‚¹å’Œä¸Šè¿°ç»„ä»¶æè¿°ï¼Œå†³å®šæœ€åˆé€‚çš„ç»„ä»¶ç±»å‹æ¥ç»„ç»‡å’Œå‘ˆç°ä¿¡æ¯ã€‚
    * ä¼˜å…ˆé€‰æ‹©èƒ½å¤Ÿæœ€å¥½åœ°ç»“æ„åŒ–ä¿¡æ¯çš„ç»„ä»¶ï¼ˆå¦‚ `icon_title_bullets`, `triple_card`, `parallel_boxes`ï¼‰ï¼Œè€Œä¸æ˜¯é›¶æ•£åœ°ä½¿ç”¨å¤šä¸ª `main_text`ï¼Œå‰ææ˜¯å†…å®¹ç»“æ„ä¸ä¹‹åŒ¹é…ã€‚
    * ç¡®ä¿æ‰€æœ‰åŸå§‹ Markdown å†…å®¹éƒ½è¢«åˆç†åœ°åˆ†é…åˆ°æŸä¸ªç»„ä»¶ä¸­ã€‚å¦‚æœæŸæ®µå†…å®¹ä¸é€‚åˆä»»ä½•ç‰¹å®šç»„ä»¶ï¼Œåº”å°†å…¶æ”¾å…¥ `main_text` å…ƒç´ ä¸­ã€‚å¯ä»¥æœ‰å¤šä¸ª `main_text` å…ƒç´ ã€‚

2.  **å†…å®¹åˆ†é…ä¸å‚æ•°å¡«å……**:
    * å°†åŸå§‹ Markdown å†…å®¹çš„ç›¸åº”éƒ¨åˆ†æ™ºèƒ½ã€å‡†ç¡®åœ°åˆ†é…ç»™æ‰€é€‰ç»„ä»¶çš„ `content_params`ã€‚
    * å¯¹äº `icon_title_bullets`ï¼šä» Markdown ä¸­æå–æ ‡é¢˜æ–‡æœ¬ï¼ˆé€šå¸¸æ¥è‡ªH2-H4çº§æ ‡é¢˜ï¼‰å’Œé¡¹ç›®ç¬¦å·åˆ—è¡¨ã€‚
    * å¯¹äº `triple_card`ï¼šå°†å†…å®¹åˆ†ä¸ºä¸‰ä¸ªé€»è¾‘å•å…ƒï¼Œæ¯ä¸ªå•å…ƒåŒ…å«æ ‡é¢˜å’Œæè¿°æ–‡æœ¬ã€‚ç¡®ä¿ `cards_data` åˆ—è¡¨æ°å¥½æœ‰ä¸‰ä¸ªå…ƒç´ ã€‚
    * å¯¹äº `parallel_boxes`ï¼šå¯»æ‰¾å¯åˆ†ä¸ºä¸¤ä¸ªè¯­ä¹‰ç›¸å…³ä¸”å†…å®¹é‡ç›¸å½“çš„æ–‡æœ¬å—ã€‚
    * ç¡®ä¿åˆ†é…ç»™ `content_params` (å¦‚ `title`, `content`, `bullets`, `statistic_value`, `label_text` ç­‰) çš„æ–‡æœ¬æ˜¯çº¯æ–‡æœ¬æˆ–å¤„ç†åçš„æ–‡æœ¬ï¼Œä¸åº”å†åŒ…å«åŸå§‹ Markdown æ ‡è®° (é™¤éå¦‚ `main_text` çš„ `text_content` é‚£æ ·æ˜ç¡®æ¥å—Markdown)ã€‚
    * å¯¹äº Emojis å’Œ Icon Charsï¼Œå¦‚æœå†…å®¹ä¸­æ²¡æœ‰æ˜ç¡®æç¤ºï¼Œæ‚¨å¯ä»¥åŸºäºè¯­ä¹‰è¿›è¡Œæ¨èæˆ–ç•™ç©ºã€‚

3.  **åˆæ­¥å†…å®¹è¯„ä¼° (è¾…åŠ©åç»­å¸ƒå±€)**:
    * å¯¹äºæ‚¨é€‰æ‹©çš„æ¯ä¸€ä¸ªç»„ä»¶ï¼Œè¯·æ ¹æ®å…¶æ‰¿è½½çš„å†…å®¹é‡ï¼Œç»™å‡ºä¸€ä¸ªå¤§è‡´çš„â€œå†…å®¹ä»½é‡â€è¯„ä¼°ï¼Œå¯é€‰å€¼ä¸ºï¼š`"low"`, `"medium"`, `"high"`ã€‚è¿™å°†å¸®åŠ©åç»­çš„å¸ƒå±€é˜¶æ®µåˆ¤æ–­ç©ºé—´éœ€æ±‚ã€‚
    * è€ƒè™‘æ•´ä½“é€‰æ‹©çš„ç»„ä»¶æ•°é‡å’Œå®ƒä»¬çš„â€œå†…å®¹ä»½é‡â€ï¼Œå¦‚æœåˆæ­¥åˆ¤æ–­æ‰€é€‰å†…å®¹åœ¨å…¸å‹å¹»ç¯ç‰‡ä¸Šå¯èƒ½ä¼šè¿‡äºæ‹¥æŒ¤æˆ–ä¿¡æ¯é‡è¿‡å¤§ï¼Œè¯·åœ¨è¾“å‡ºçš„é¡¶å±‚æ·»åŠ ä¸€ä¸ª `layout_density_warning` å­—æ®µï¼Œå€¼ä¸º `true`ã€‚

è¾“å‡ºæ ¼å¼ï¼š
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¿”å›ã€‚JSON åº”åŒ…å«ä¸€ä¸ªåä¸º `selected_elements` çš„åˆ—è¡¨ã€‚åˆ—è¡¨ä¸­çš„æ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€ä¸ªè¢«é€‰ä¸­çš„å¹»ç¯ç‰‡å…ƒç´ ï¼Œå¹¶åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
* `element_type` (str): ç»„ä»¶ç±»å‹ã€‚
* `content_params` (dict): ç‰¹å®šäºè¯¥ç»„ä»¶çš„å†…å®¹å‚æ•°ã€‚
* `style_id` (str, optional): ç»„ä»¶çš„æ ·å¼ ID (å¦‚æœé€‚ç”¨)ã€‚
* `estimated_content_volume` (str): å†…å®¹ä»½é‡è¯„ä¼° (`"low"`, `"medium"`, `"high"`)ã€‚

å¦‚æœè¯„ä¼°åè®¤ä¸ºå†…å®¹å¯èƒ½è¿‡äºå¯†é›†ï¼Œè¯·åœ¨JSONçš„é¡¶å±‚åŒ…å« `layout_density_warning: true`ã€‚

{{
  "layout_density_warning": false, // æˆ–è€… true å¦‚æœè¯„ä¼°å†…å®¹è¿‡å¤š
  "selected_elements": [
    {{
      "element_type": "icon_title_bullets",
      "content_params": {{ "icon_emoji": "ğŸ’¡", "content_data": {{ "title": "æ ¸å¿ƒæ´å¯Ÿ", "bullets": ["å‘ç°ç‚¹A", "å‘ç°ç‚¹B"] }} }},
      "estimated_content_volume": "medium"
    }},
    {{
      "element_type": "main_text",
      "content_params": {{ "text_content": "è¿™æ˜¯ä¸€æ®µè¡¥å……è¯´æ˜æˆ–è€…ä¸é€‚åˆæ”¾å…¥å…¶ä»–ç»„ä»¶çš„æ–‡æœ¬ã€‚" }},
      "estimated_content_volume": "low"
    }}
    // ... æ›´å¤šåŸºäºMarkdownå†…å®¹é€‰æ‹©å’Œåˆ†é…çš„å…ƒç´ 
  ]
}}"""

PROMPT_2_LAYOUT_AND_SIZING = """è¯·æ‰®æ¼”ä¸€ä½ç»éªŒä¸°å¯Œçš„æ¼”ç¤ºæ–‡ç¨¿è®¾è®¡å¸ˆå’Œç©ºé—´å¸ƒå±€ä¸“å®¶ã€‚
æ‚¨çš„ä»»åŠ¡æ˜¯æ¥æ”¶ä¸€ç»„é¢„é€‰çš„å¹»ç¯ç‰‡ç»„ä»¶åŠå…¶å†…å®¹ï¼Œå¹¶ä¸ºè¿™äº›ç»„ä»¶åœ¨å¹»ç¯ç‰‡ä¸Šè¿›è¡Œç²¾ç¡®çš„å¸ƒå±€è®¾è®¡ã€‚è¿™åŒ…æ‹¬å†³å®šå®ƒä»¬çš„ä½ç½®ã€å°ºå¯¸ï¼Œå¹¶ä¸ºç‰¹å®šç»„ä»¶å»ºè®®æ–‡æœ¬å’ŒEmojiçš„è§†è§‰å¤§å°ã€‚å¿…é¡»ä¸¥æ ¼éµå®ˆæ‰€æœ‰è¾¹ç•Œå’Œå¸ƒå±€çº¦æŸï¼Œå¹¶åœ¨å¿…è¦æ—¶è¿›è¡Œè°ƒæ•´ä»¥é˜²æ­¢å†…å®¹æº¢å‡ºã€‚

å·²çŸ¥æ ¸å¿ƒå¸ƒå±€å‚æ•°ï¼š
1.  **å¹»ç¯ç‰‡ç‰©ç†å®½åº¦**: 10 è‹±å¯¸ (Inches)
2.  **å¹»ç¯ç‰‡ç‰©ç†é«˜åº¦**: 7.5 è‹±å¯¸ (Inches)
3.  **å†…å®¹åŒºè¾¹è·**: å·¦å³å„ 0.5 è‹±å¯¸ï¼Œä¸Šæ–¹1.5è‹±å¯¸ï¼Œä¸‹æ–¹0.5è‹±å¯¸
4.  **å†…å®¹åŒºå¯ç”¨å®½åº¦**: 9.0 è‹±å¯¸ (è®¡ç®—ç»“æœ: 10.0 - 2*0.5)
5.  **å†…å®¹åŒºå¯ç”¨é«˜åº¦**: 5.5 è‹±å¯¸ (è®¡ç®—ç»“æœ: 7.5 - 1.5 - 0.5)
6.  **å†…å®¹åŒºç»å¯¹èµ·å§‹åæ ‡**: `left_start = 0.5`, `top_start = 1.5`
7.  **å†…å®¹åŒºç»å¯¹ç»“æŸè¾¹ç•Œ**: `right_boundary = 9.5` (å³ `left_start + å†…å®¹åŒºå¯ç”¨å®½åº¦`), `bottom_boundary = 7.0` (å³ `top_start + å†…å®¹åŒºå¯ç”¨é«˜åº¦`)
8.  **ç»„ä»¶é—´å»ºè®®æœ€å°é—´è·**: 0.25 è‹±å¯¸ (ç”¨äºå…ƒç´ ä¸Šä¸‹å·¦å³çš„åˆ†éš”)

è¾“å…¥æ•°æ® (æ¥è‡ªç¬¬ä¸€é˜¶æ®µçš„è¾“å‡º):
```json
{input_selected_elements_json}
```
è¯¥JSONåŒ…å«ä¸€ä¸ª `selected_elements` åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ æœ‰ `element_type`, `content_params`, `style_id` (å¯é€‰), å’Œ `estimated_content_volume`ã€‚

éœ€æ±‚ï¼š
1.  **ä¸¥æ ¼éµå®ˆè¾¹ç•Œä¸å¸ƒå±€è§„åˆ™ (æœ€é«˜ä¼˜å…ˆçº§)**:
    * æ‰€æœ‰å…ƒç´ çš„ `left` åæ ‡å¿…é¡» `>= å†…å®¹åŒºç»å¯¹èµ·å§‹åæ ‡.left_start` (0.5 è‹±å¯¸)ã€‚
    * æ‰€æœ‰å…ƒç´ çš„å³è¾¹ç¼˜ (`left + width`) å¿…é¡» `<= å†…å®¹åŒºç»å¯¹ç»“æŸè¾¹ç•Œ.right_boundary` (9.5 è‹±å¯¸)ã€‚
    * æ‰€æœ‰å…ƒç´ çš„ `top` åæ ‡å¿…é¡» `>= å†…å®¹åŒºç»å¯¹èµ·å§‹åæ ‡.top_start` (1.5 è‹±å¯¸)ã€‚
    * æ‰€æœ‰å…ƒç´ çš„ä¸‹è¾¹ç¼˜ (`top + height`) å¿…é¡» `<= å†…å®¹åŒºç»å¯¹ç»“æŸè¾¹ç•Œ.bottom_boundary` (7.0 è‹±å¯¸)ã€‚**æ­¤ä¸ºç¡¬æ€§é™åˆ¶ï¼Œä¸å¾—è¶…å‡ºã€‚**
    * åœ¨å‚ç›´æ–¹å‘ä¸Šï¼Œæ‰€æœ‰ç»„ä»¶çš„ `height` åŠå…¶ä¹‹é—´çš„é—´è· (è‡³å°‘0.25è‹±å¯¸) çš„æ€»å’Œï¼Œä¸å¾—è¶…è¿‡å†…å®¹åŒºçš„å¯ç”¨é«˜åº¦ (5.5è‹±å¯¸)ã€‚è¯·åœ¨å¸ƒå±€æ—¶è¿›è¡Œå…¨å±€è€ƒé‡ã€‚

2.  **ç»„ä»¶å°ºå¯¸ä¸ä½ç½®ç¡®å®š (`position` å’Œ `size`)**:
    * ä¸º `input_selected_elements_json` ä¸­çš„æ¯ä¸€ä¸ªç»„ä»¶ç¡®å®šå…¶åœ¨å¹»ç¯ç‰‡ä¸Šçš„ç²¾ç¡® `position` (`left`, `top`) å’Œ `size` (`width`, `height`)ã€‚å•ä½ä¸ºè‹±å¯¸ã€‚
    * åœ¨ä¼°è®¡ç»„ä»¶ï¼ˆå°¤å…¶æ˜¯åŒ…å«æ–‡æœ¬çš„ç»„ä»¶ï¼‰çš„ `height` å’Œ `width` æ—¶ï¼Œéœ€ä»”ç»†è€ƒè™‘å…¶å†…éƒ¨æ–‡æœ¬å†…å®¹çš„å¤šå°‘ï¼ˆå¯å‚è€ƒè¾“å…¥çš„ `estimated_content_volume`ï¼‰ã€é¢„ä¼°çš„æ–‡æœ¬å’ŒEmojiå¤§å°ï¼ˆå‚è€ƒéœ€æ±‚3ï¼‰ã€å¿…è¦çš„å†…è¾¹è·ï¼ˆç»„ä»¶å†…å®¹è·ç¦»å…¶è¾¹ç•Œè‡³å°‘æœ‰0.1åˆ°0.2è‹±å¯¸ï¼‰å’Œèˆ’é€‚çš„è¡Œé«˜ï¼ˆä¾‹å¦‚å­—ä½“é«˜åº¦çš„1.2-1.5å€ï¼‰ã€‚
    * **`main_text` ç»„ä»¶çš„é«˜åº¦å¤„ç†**:
        * å…¶ `height` **å¿…é¡»**æ ¹æ® `text_content` çš„å®é™…è¡Œæ•°ã€å»ºè®®çš„å­—ä½“å¤§å°ï¼ˆå†…å®¹é»˜è®¤12ptï¼Œè¡Œé«˜ä¸ºå…¶1.2-1.5å€ï¼‰è¿›è¡Œ**æœ€å°åŒ–è®¡ç®—**ã€‚ç»„ä»¶å†…éƒ¨ä¸Šä¸‹æ€»å†…è¾¹è·ä¸åº”è¶…è¿‡0.2è‹±å¯¸ã€‚
        * **å¦‚æœ `main_text` çš„æ–‡æœ¬å†…å®¹å¾ˆå°‘ï¼ˆä¾‹å¦‚ä¸€ä¸¤è¡Œï¼‰ï¼Œå…¶é«˜åº¦åº”è¯¥éå¸¸å°ï¼Œä»¥é¿å…ä¸å¿…è¦çš„ç©ºç™½ã€‚**
        * å¦‚æœ `main_text` ç”¨äºæ”¾ç½®å°‘é‡è¡¥å……æ–‡æœ¬ï¼Œå…¶ `width` ä¹Ÿå¯é€‚å½“ç¼©å°ï¼Œæ— éœ€é»˜è®¤å æ®æ•´ä¸ªå¯ç”¨å®½åº¦ã€‚
    * å¯¹äº `divider`ï¼Œå…¶ `size.height` é€šå¸¸éå¸¸å° (å¯è®¾ä¸ºåä¹‰å€¼å¦‚ 0.1 è‹±å¯¸)ï¼Œä¸»è¦ç¡®å®š `left`, `top`, `width`ã€‚
    * ç¡®ä¿å…ƒç´ ä¹‹é—´æœ‰é€‚å½“çš„é—´è·ï¼ˆå»ºè®®è‡³å°‘ 0.25 è‹±å¯¸ï¼‰ï¼Œé¿å…è§†è§‰æ‹¥æŒ¤å’Œé‡å ã€‚
    * è€ƒè™‘æ•´ä½“çš„è§†è§‰å¹³è¡¡ã€å±‚çº§å…³ç³»å’Œé˜…è¯»æµç¨‹ï¼ˆé€šå¸¸ä»ä¸Šåˆ°ä¸‹ã€ä»å·¦åˆ°å³ï¼‰ã€‚

3.  **å»ºè®®æ–‡æœ¬å’ŒEmojiå°ºå¯¸ (`text_size`)**:
    * å¯¹äºä»¥ä¸‹ç‰¹å®šç»„ä»¶ç±»å‹ï¼Œå¦‚æœå®ƒä»¬å‡ºç°åœ¨æœ€ç»ˆçš„ `layout_elements` ä¸­ï¼Œè¯·åœ¨è¾“å‡ºä¸­åŒ…å«ä¸€ä¸ªåä¸º `text_size` çš„å­—å…¸ï¼Œç”¨äºå»ºè®®çš„å­—ä½“å’ŒEmojiå¤§å° (å•ä½: pt)ï¼š
        * **`icon_title_bullets`**: `text_size` åŒ…å« `title_size`, `content_size`, å’Œ `emoji_size`ã€‚
        * **`triple_card`**: `text_size` åŒ…å« `title_size`, `content_size`, å’Œ `emoji_size`ã€‚
        * **`parallel_boxes`**: `text_size` åŒ…å« `content_size`, å’Œ `emoji_size`ã€‚
    * æ‚¨éœ€è¦æ ¹æ®ç»„ä»¶å†…å®¹ã€å…¶ `estimated_content_volume` ä»¥åŠæ•´ä½“è§†è§‰å’Œè°æ€§ï¼Œä¸ºè¿™äº› `*_size` å­—æ®µå»ºè®®åˆé€‚çš„ã€åœ¨æ¼”ç¤ºæ–‡ç¨¿ä¸­æ¸…æ™°å¯è¯»çš„ `pt` å€¼ã€‚è¿™äº›å»ºè®®å€¼åº”ä¸æ‚¨åœ¨éœ€æ±‚2ä¸­è®¡ç®—çš„ç»„ä»¶ `width` å’Œ `height` ç›¸è¾…ç›¸æˆã€‚
    * å¦‚æœä¸ºäº†æ»¡è¶³å¸ƒå±€çº¦æŸï¼ˆå°¤å…¶æ˜¯ä¸‹è¾¹ç•Œé™åˆ¶ï¼‰ï¼Œå¯ä»¥è€ƒè™‘åœ¨åˆç†èŒƒå›´å†…å¾®è°ƒ `content_size`ï¼ˆä¾‹å¦‚ï¼Œæœ€å°ä¸ä½äº10ptï¼‰ï¼Œä½†åº”ä¼˜å…ˆé€šè¿‡è°ƒæ•´ç»„ä»¶ `height` æ¥è§£å†³ã€‚

4.  **æœ€ç»ˆæ£€æŸ¥ä¸è°ƒæ•´ (Final Check and Adjustment)**:
    * åœ¨å®Œæˆæ‰€æœ‰å…ƒç´ çš„åˆæ­¥å¸ƒå±€å’Œå°ºå¯¸è®¾å®šåï¼Œè¯·è¿›è¡Œä¸€æ¬¡æœ€ç»ˆæ£€æŸ¥ã€‚
    * å¦‚æœå‘ç°ä»»ä½•å…ƒç´ çš„ä¸‹è¾¹ç¼˜ (`top + height`) ä¾ç„¶è¶…å‡º `å†…å®¹åŒºç»å¯¹ç»“æŸè¾¹ç•Œ.bottom_boundary` (7.0 è‹±å¯¸)ï¼Œæˆ–è€…æ‰€æœ‰å…ƒç´ åŠ ä¸Šå®ƒä»¬ä¹‹é—´çš„å‚ç›´é—´è·åçš„æ€»é«˜åº¦è¶…è¿‡äº† `å†…å®¹åŒºå¯ç”¨é«˜åº¦` (5.5 è‹±å¯¸)ï¼Œåˆ™**å¿…é¡»é‡‡å–ä»¥ä¸‹ä¸€ç§æˆ–å¤šç§æªæ–½è¿›è¡Œè°ƒæ•´ï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼Œç›´è‡³æ»¡è¶³æ‰€æœ‰è¾¹ç•Œçº¦æŸ**ï¼š
        1.  **ä¼˜å…ˆå‹ç¼© `main_text` çš„é«˜åº¦**ï¼šå¦‚æœå¹»ç¯ç‰‡ä¸­å­˜åœ¨`main_text`å…ƒç´ ï¼Œå¹¶ä¸”å…¶å†…å®¹å…è®¸ï¼Œè¿›ä¸€æ­¥å‹ç¼©å…¶é«˜åº¦è‡³æœ€å°å¿…è¦å€¼ã€‚
        2.  **å‡å°‘å…ƒç´ é—´çš„å‚ç›´é—´è·**ï¼šå¯ä»¥å°†å»ºè®®çš„0.25è‹±å¯¸é—´è·é€‚å½“å‡å°ï¼ˆä¾‹å¦‚ï¼Œé€æ­¥å‡è‡³0.2è‹±å¯¸ï¼Œç”šè‡³0.15è‹±å¯¸ï¼‰ï¼Œä½†å¿…é¡»ä¿æŒè§†è§‰ä¸Šçš„åŸºæœ¬åŒºéš”ã€‚
        3.  **ç»Ÿä¸€è°ƒæ•´ä¸€ç»„å¯¼è‡´æº¢å‡ºçš„å…ƒç´ çš„é«˜åº¦**ï¼šå¦‚æœä¸€ç»„å‚ç›´æˆ–æ°´å¹³æ’åˆ—çš„å…ƒç´ ï¼ˆä¾‹å¦‚åº•éƒ¨çš„å¤šä¸ªå¡ç‰‡ï¼‰æ˜¯å¯¼è‡´æº¢å‡ºçš„ä¸»è¦åŸå› ï¼Œå¯ä»¥è€ƒè™‘ç•¥å¾®ï¼ˆç»Ÿä¸€åœ°ï¼‰å‡å°è¿™äº›å…ƒç´ çš„é«˜åº¦ã€‚è¿™å¯èƒ½éœ€è¦åŒæ—¶ç•¥å¾®å‡å°å…¶å†…éƒ¨å†…å®¹çš„å­—ä½“å¤§å°ï¼ˆä¾‹å¦‚ï¼Œ`content_size` æœ€å°ä¸ä½äº9ptæˆ–10ptï¼Œä»¥ä¿è¯å¯è¯»æ€§ï¼‰ã€‚
        4.  **ç•¥å¾®å‡å°éå…³é”®æ–‡æœ¬ç»„ä»¶çš„å­—ä½“å¤§å°**ï¼šå¯¹äºéæ ‡é¢˜ã€éæ ¸å¿ƒæ•°æ®æ ‡æ³¨çš„æ–‡æœ¬å†…å®¹ï¼Œåœ¨å¯è¯»æ€§å…è®¸çš„å‰æä¸‹ï¼Œå¯ä»¥è€ƒè™‘å°† `content_size` å†é™ä½1ptï¼ˆä¾‹å¦‚ï¼Œä»12pté™è‡³11ptï¼‰ã€‚
    * **æœ€ç»ˆç›®æ ‡æ˜¯ï¼šç»ä¸å…è®¸ä»»ä½•å†…å®¹æº¢å‡ºå®šä¹‰çš„å†…å®¹åŒºè¾¹ç•Œã€‚**

è¾“å‡ºæ ¼å¼ï¼š
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¿”å›ã€‚JSON åº”åŒ…å«ä¸€ä¸ªåä¸º `layout_elements` çš„åˆ—è¡¨ã€‚åˆ—è¡¨ä¸­çš„æ¯ä¸ªå¯¹è±¡ä»£è¡¨ä¸€ä¸ªå¹»ç¯ç‰‡å…ƒç´ ï¼Œå¹¶åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
* `element_type` (str): ç»„ä»¶ç±»å‹ã€‚
* `content_params` (dict): ä»è¾“å…¥ç»§æ‰¿çš„è¯¥ç»„ä»¶çš„å†…å®¹å‚æ•°ã€‚
* `style_id` (str, optional): ä»è¾“å…¥ç»§æ‰¿çš„ç»„ä»¶æ ·å¼ IDã€‚
* `position` (dict): {{ "left": float, "top": float }} (å•ä½ï¼šè‹±å¯¸)ã€‚
* `size` (dict): {{ "width": float, "height": float }} (å•ä½ï¼šè‹±å¯¸)ã€‚
* `text_size` (dict, optional): åŒ…å«å»ºè®®çš„æ–‡æœ¬å’ŒEmojiå°ºå¯¸ï¼ˆå•ä½: ptï¼‰ã€‚

```json
{{
  "layout_elements": [
    {{
      "element_type": "icon_title_bullets",
      "content_params": {{ "icon_emoji": "ğŸ’¡", "content_data": {{ "title": "æ ¸å¿ƒæ´å¯Ÿ", "bullets": ["å‘ç°ç‚¹A", "å‘ç°ç‚¹B"] }} }},
      "position": {{ "left": 0.5, "top": 1.5 }},
      "size": {{ "width": 8.5, "height": 2.0 }},
      "text_size": {{
        "title_size": 20,
        "content_size": 12,
        "emoji_size": 22
      }}
    }},
    {{
      "element_type": "main_text",
      "content_params": {{ "text_content": "è¿™æ˜¯ä¸€æ®µè¡¥å……è¯´æ˜ã€‚" }},
      "position": {{ "left": 0.5, "top": 3.75 }}, // top = 1.5 (previous_top) + 2.0 (previous_height) + 0.25 (spacing)
      "size": {{ "width": 8.5, "height": 0.5 }} // é«˜åº¦ä¸¥æ ¼æ ¹æ®å†…å®¹è®¡ç®—
    }}
    // ... æ›´å¤šå¸ƒå±€å¥½çš„å…ƒç´ 
  ]
}}
"""

class SplitComponentAgent:
    def __init__(self):
        self.config = get_args_parser()
        self.LLM = OpenAI(
            api_key=self.config.OPENAI_API_KEY,
            base_url=self.config.OPENAI_BASE_URL)
        self.model = self.config.model

    def get_openai_response(self, prompt_text: str, client: OpenAI, model: str) -> dict:
        """
        å‘ OpenAI API å‘é€è¯·æ±‚å¹¶è·å– JSON æ ¼å¼çš„å“åº”ã€‚

        Args:
            prompt_text: è¦å‘é€ç»™æ¨¡å‹çš„å®Œæ•´æç¤ºã€‚
            client: åˆå§‹åŒ–åçš„ OpenAI å®¢æˆ·ç«¯ã€‚
            model: è¦ä½¿ç”¨çš„ OpenAI æ¨¡å‹ã€‚

        Returns:
            ä¸€ä¸ªåŒ…å«æ¨¡å‹å“åº”çš„å­—å…¸ (å·²è§£æçš„ JSON)ã€‚
        """
        try:
            completion = client.chat.completions.create(
                model=model,
                messages=[
                    {"role": "system", "content": "You are an expert presentation designer and information architect. Your goal is to generate valid JSON based on the user's instructions."},
                    {"role": "user", "content": prompt_text}
                ],
                response_format={"type": "json_object"}, # è¯·æ±‚ JSON è¾“å‡º
                temperature=0.2 # ä½æ¸©ä»¥è·å¾—æ›´ä¸€è‡´å’Œç»“æ„åŒ–çš„è¾“å‡º
            )
            raw_content = completion.choices[0].message.content
            if "</think>" in raw_content.strip():
                raw_content = raw_content.strip().split("</think>", 1)[1]
            if "```json" in raw_content.strip():
                raw_content = raw_content.strip().split("```json", 1)[1]
                if "```" in raw_content:
                    raw_content = raw_content.rsplit("```", 1)[0]
            response_content = raw_content.strip()
            if response_content:
                return json.loads(response_content)
            else:
                print("Error: Received empty response content from OpenAI.")
                return {}
        except Exception as e:
            print(f"Error calling OpenAI API: {e}")
            return {}

    def generate_slide_layout_from_markdown(self,markdown_content: str) -> dict:
        """
        é€šè¿‡ä¸¤æ­¥æç¤ºç­–ç•¥ä» Markdown å†…å®¹ç”Ÿæˆå¹»ç¯ç‰‡å¸ƒå±€ã€‚

        Args:
            markdown_content: åŸå§‹çš„ Markdown å­—ç¬¦ä¸²ã€‚

        Returns:
            åŒ…å«æœ€ç»ˆå¹»ç¯ç‰‡å¸ƒå±€å…ƒç´ çš„å­—å…¸ï¼Œå¦‚æœå‡ºé”™åˆ™ä¸ºç©ºå­—å…¸ã€‚
        """
        for i in range(3):  # æœ€å¤šå°è¯•3æ¬¡
            try:
                # self.LL
                # --- æ­¥éª¤ 1: å†…å®¹åˆ†æä¸ç»„ä»¶é€‰æ‹© ---
                prompt1_filled = PROMPT_1_CONTENT_ANALYSIS_AND_COMPONENT_SELECTION.format(markdown_content=markdown_content)
                selected_elements_response = self.get_openai_response(prompt1_filled, self.client, self.model)
                if not selected_elements_response or "selected_elements" not in selected_elements_response:
                    assert 0==1

                # --- æ­¥éª¤ 2: ç»„ä»¶å¸ƒå±€ä¸å°ºå¯¸è®¾å®š ---
                selected_elements_json_str = json.dumps(selected_elements_response, ensure_ascii=False)
                prompt2_filled = PROMPT_2_LAYOUT_AND_SIZING.format(input_selected_elements_json=selected_elements_json_str)
                final_layout_response = self.get_openai_response(prompt2_filled, self.client, self.model)
                if not final_layout_response or 'layout_elements' not in final_layout_response:
                    assert 0 == 1
                if 'element_type' not in final_layout_response['layout_elements'][0] \
                        or 'content_params' not in final_layout_response['layout_elements'][0] \
                        or 'position' not in final_layout_response['layout_elements'][0] \
                        or 'size' not in final_layout_response['layout_elements'][0]:
                    assert 0 == 1
                return final_layout_response

            except:
                print(f"è°ƒç”¨ LLM æ—¶å‘ç”Ÿé¢„æ–™ä¹‹å¤–çš„é”™è¯¯ (å°è¯• {i + 1}/{3})")

            if i < 2:  # å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•
                time.sleep(1)  # é‡è¯•å‰ç­‰å¾…1ç§’